apiVersion: apiextensions.crossplane.io/v1
kind: Composition
metadata:
  name: childaccount
  labels:
      provider: provider-aws
      name: childaccount
spec:
  compositeTypeRef:
    apiVersion: cloudspace.resources/v1alpha1
    kind: ChildAccount
  writeConnectionSecretsToNamespace: crossplane-system
  patchSets:
  - name: metadata
    patches:
    - fromFieldPath: metadata.labels
  resources:
  - name: child-account
    base:
      apiVersion: organizations.aws.upbound.io/v1beta1
      kind: Account
      spec:
        forProvider:
          email: awsaccountadmin+crossplane.customername@ubixlabs.com
          name: crossplanecreated
          parentId: ou-8jat-sv0412tm
        providerConfigRef:
          name: root
    patches:
    - type: ToCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
    - type: ToCompositeFieldPath
      fromFieldPath: spec.parameters.email
      toFieldPath: spec.forProvider.email
    - type: ToCompositeFieldPath
      fromFieldPath: spec.parameters.name
      toFieldPath: spec.forProvider.name
    - type: ToCompositeFieldPath
      fromFieldPath: spec.parameters.parentId
      toFieldPath: spec.forProvider.parentId
    - type: ToCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: ToCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.writeConnectionSecretToRef.name
      transforms:
        - type: string
          string:
            fmt: "%s-awsaccount"
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.id
      toFieldPath: status.id
    - type: ToCompositeFieldPath
      fromFieldPath: spec.writeConnectionSecretToRef.namespace
      toFieldPath: spec.writeConnectionSecretToRef.namespace
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.status
      toFieldPath: status.accountStatus
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.arn
      toFieldPath: status.arn
    readinessChecks:
    - type: MatchString
      fieldPath: status.atProvider.status
      matchString: ACTIVE
    connectionDetails:
      - fromConnectionSecretKey: kubeconfig

#this resource is key to deploy everything inside the newly created account
  - name: provider-config
    base:
      apiVersion: aws.upbound.io/v1beta1
      kind: ProviderConfig
      metadata:
        #name: crossplane-test-pconfig
        labels:
          provider: provider-aws
          name: childaccount
      spec:
        #assumeRoleARN: "arn:aws:iam::798374069605:role/OrganizationAccountAccessRole"
        credentials:
          source: IRSA
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: metadata.name
    - type: ToCompositeFieldPath
      fromFieldPath: metadata.labels
      toFieldPath: metadata.labels
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.assumeRoleChain[0].roleARN
      transforms:
        - type: string
          string:
            fmt: "arn:aws:iam::%s:role/OrganizationAccountAccessRole"

  - name: vpc
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: VPC
      spec:
        forProvider:
          enableDnsHostnames: true
          cidrBlock: 10.0.0.0/16
          enableDnsSupport: true
    patches:
    - type: ToCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
    - type: ToCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.id
      toFieldPath: status.vpcID

##
# EKS Security Groups
##

  - name: node-security-group
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: SecurityGroup
      spec:
        forProvider:
          tags:
            karpenter.sh/discovery: #patchme
          description: Security group for all nodes in the cluster
          name: #patchme
          region: #patchme
          vpcIdRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.tags[karpenter.sh/discovery]
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - string:
          fmt: '%s-node-sg'
        type: string
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.name
      transforms:
      - string:
          fmt: '%s-node-sg'
        type: string
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.vpcIdRef.name
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.id
      toFieldPath: status.nodeSecurityGroupID
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: node-security-group-rule-egress
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: SecurityGroupRule
      spec:
        forProvider:
          cidrBlocks:
          - 0.0.0.0/0
          description: Allow egress from the nodes
          ipv6CidrBlocks:
          - ::/0
          fromPort: 0
          protocol: "-1"
          toPort: 0
          type: egress
          region: #patchme
          securityGroupIdRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - string:
          fmt: '%s-sg-rule-node-egress'
        type: string
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.securityGroupIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-node-sg'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: node-security-group-ingress-self
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: SecurityGroupRule
      spec:
        forProvider:
          description: Allow node to communicate with each other
          fromPort: 0
          protocol: "-1"
          toPort: 65535
          type: ingress
          region: #patchme
          securityGroupIdRef:
            name: #patchme
          sourceSecurityGroupIdRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - string:
          fmt: '%s-sg-rule-node-to-node'
        type: string
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.securityGroupIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-node-sg'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.sourceSecurityGroupIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-node-sg'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: node-security-group-ingress-cluster
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: SecurityGroupRule
      spec:
        forProvider:
          description: Allow worker Kubelets and pods to receive communication from
            the cluster control plane
          fromPort: 1025
          protocol: tcp
          toPort: 65535
          type: ingress
          region: #patchme
          securityGroupIdRef:
            name: #patchme
          sourceSecurityGroupIdRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - string:
          fmt: '%s-sg-rule-kubelets'
        type: string
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.securityGroupIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-node-sg'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.sourceSecurityGroupIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-ekscluster-sg'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: cluster-security-group
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: SecurityGroup
      spec:
        forProvider:
          description: Cluster communication with worker nodes
          name: #patchme
          region: #patchme
          vpcIdRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - string:
          fmt: '%s-ekscluster-sg'
        type: string
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.name
      transforms:
      - string:
          fmt: '%s-ekscluster-sg'
        type: string
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.vpcIdRef.name
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.id
      toFieldPath: status.clusterSecurityGroupID
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: cluster-security-group-rule-ingress
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: SecurityGroupRule
      spec:
        forProvider:
          description: Allow pods to communicate with the cluster API Server -
          fromPort: 443
          protocol: tcp
          toPort: 443
          type: ingress
          region: #patchme
          securityGroupIdRef:
            name: #patchme
          sourceSecurityGroupIdRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - string:
          fmt: '%s-sg-rule-pods-to-api-server'
        type: string
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.securityGroupIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-ekscluster-sg'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.sourceSecurityGroupIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-node-sg'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
  
  - name: cluster-security-group-rule-egress-api-server-to-pods
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: SecurityGroupRule
      spec:
        forProvider:
          description: Cluster API to node groups
          fromPort: 443
          protocol: tcp
          toPort: 443
          type: egress
          region: #patchme
          securityGroupIdRef:
            name: #patchme
          sourceSecurityGroupIdRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - string:
          fmt: '%s-sg-rule-api-server-to-pods'
        type: string
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.securityGroupIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-ekscluster-sg'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.sourceSecurityGroupIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-node-sg'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: cluster-security-group-rule-egress-ephemeral-ports
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: SecurityGroupRule
      spec:
        forProvider:
          description: Allow pods to communicate with using ephemeral ports.
          fromPort: 1025
          protocol: tcp
          toPort: 65535
          type: egress
          region: #patchme
          securityGroupIdRef:
            name: #patchme
          sourceSecurityGroupIdRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - string:
          fmt: '%s-sg-rule-pods-ephemeral-ports'
        type: string
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.securityGroupIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-ekscluster-sg'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.sourceSecurityGroupIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-node-sg'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: cluster-primary-security-group-rule-dns-tcp
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: SecurityGroupRule
      spec:
        forProvider:
          description: Allow pods to communicate with CoreDNS
          fromPort: 53
          protocol: tcp
          toPort: 53
          type: ingress
          region: #patchme
          securityGroupId: #patchme
          sourceSecurityGroupIdRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - string:
          fmt: '%s-sg-rule-pods-to-core-dns-tcp'
        type: string
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: status.clusterPrimarySecurityGroupId
      toFieldPath: spec.forProvider.securityGroupId
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.sourceSecurityGroupIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-node-sg'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: cluster-primary-security-group-rule-dns-udp
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: SecurityGroupRule
      spec:
        forProvider:
          description: Allow pods to communicate with CoreDNS
          fromPort: 53
          protocol: udp
          toPort: 53
          type: ingress
          region: #patchme
          securityGroupId: #patchme
          sourceSecurityGroupIdRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - string:
          fmt: '%s-sg-rule-pods-to-core-dns-udp'
        type: string
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: status.clusterPrimarySecurityGroupId
      toFieldPath: spec.forProvider.securityGroupId
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.sourceSecurityGroupIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-node-sg'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: node-security-group-rule-ingress-efs
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: SecurityGroupRule
      spec:
        forProvider:
          cidrBlocks:
          - 0.0.0.0/0
          description: Allow efs ingress communication
          fromPort: 2049
          protocol: tcp
          toPort: 2049
          type: ingress
          region: #patchme
          securityGroupIdRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - string:
          fmt: '%s-sg-rule-node-ingress-efs'
        type: string
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.securityGroupIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-node-sg'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: node-security-group-ingress-cluster-4443
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: SecurityGroupRule
      spec:
        forProvider:
          description: "Allow access from control plane to webhook for metrics server."
          fromPort: 4443
          protocol: tcp
          toPort: 4443
          type: ingress
          region: #patchme
          securityGroupIdRef:
            name: #patchme
          sourceSecurityGroupIdRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - string:
          fmt: '%s-sg-rule-4443'
        type: string
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.securityGroupIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-node-sg'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.sourceSecurityGroupIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-ekscluster-sg'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: node-security-group-ingress-cluster-6443
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: SecurityGroupRule
      spec:
        forProvider:
          description: "Allow access from control plane for Prometheus Server."
          fromPort: 6443
          protocol: tcp
          toPort: 6443
          type: ingress
          region: #patchme
          securityGroupIdRef:
            name: #patchme
          sourceSecurityGroupIdRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - string:
          fmt: '%s-sg-rule-6443'
        type: string
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.securityGroupIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-node-sg'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.sourceSecurityGroupIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-ekscluster-sg'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: node-security-group-ingress-cluster-8443
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: SecurityGroupRule
      spec:
        forProvider:
          description: "Allow access from control plane for Karpenter."
          fromPort: 8443
          protocol: tcp
          toPort: 8443
          type: ingress
          region: #patchme
          securityGroupIdRef:
            name: #patchme
          sourceSecurityGroupIdRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - string:
          fmt: '%s-sg-rule-8443'
        type: string
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.securityGroupIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-node-sg'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.sourceSecurityGroupIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-ekscluster-sg'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: node-security-group-ingress-cluster-9443
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: SecurityGroupRule
      spec:
        forProvider:
          description: "Allow access from control plane to webhook port of AWS load balancer/NGINX controller."
          fromPort: 9443
          protocol: tcp
          toPort: 9443
          type: ingress
          region: #patchme
          securityGroupIdRef:
            name: #patchme
          sourceSecurityGroupIdRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - string:
          fmt: '%s-sg-rule-9443'
        type: string
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.securityGroupIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-node-sg'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.sourceSecurityGroupIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-ekscluster-sg'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: node-security-group-ingress-cluster-10260
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: SecurityGroupRule
      spec:
        forProvider:
          description: "Allow access from control plane to webhook port 10260(cert-manage-webhook)."
          fromPort: 10260
          protocol: tcp
          toPort: 10260
          type: ingress
          region: #patchme
          securityGroupIdRef:
            name: #patchme
          sourceSecurityGroupIdRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - string:
          fmt: '%s-sg-rule-10260'
        type: string
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.securityGroupIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-node-sg'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.sourceSecurityGroupIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-ekscluster-sg'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: node-security-group-ingress-cluster-10250
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: SecurityGroupRule
      spec:
        forProvider:
          description: "Allow access from control plane to webhook port 10250."
          fromPort: 10250
          protocol: tcp
          toPort: 10250
          type: ingress
          region: #patchme
          securityGroupIdRef:
            name: #patchme
          sourceSecurityGroupIdRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - string:
          fmt: '%s-sg-rule-10250'
        type: string
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.securityGroupIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-node-sg'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.sourceSecurityGroupIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-ekscluster-sg'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

##
# End EKS Security Group
##

  - name: public-subnet-1a
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: Subnet
      spec:
        forProvider:
          region: #patched
          availabilityZone: #patched
          cidrBlock: 10.0.0.0/24
          vpcIdRef:
            name: #patched
          mapPublicIpOnLaunch: true
          tags:
            kubernetes.io/role/elb: "1"
      providerConfigRef:
        policy:
          resolve: "Always"
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: 'public-%s-1a'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.availabilityZone
      transforms:
      - type: string
        string:
          fmt: '%sa'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.vpcIdRef.name
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.id
      toFieldPath: status.publicSubnet1aID

  - name: public-subnet-1b
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: Subnet
      spec:
        forProvider:
          region: #patched
          availabilityZone: #patched
          cidrBlock: 10.0.1.0/24
          vpcIdRef:
            name: #patched
          mapPublicIpOnLaunch: true
          tags:
            kubernetes.io/role/elb: "1"
      providerConfigRef:
        policy:
          resolve: "Always"
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: 'public-%s-1b'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.availabilityZone
      transforms:
      - type: string
        string:
          fmt: '%sb'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.vpcIdRef.name
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.id
      toFieldPath: status.publicSubnet1bID

  - name: public-subnet-1c
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: Subnet
      spec:
        forProvider:
          region: #patched
          availabilityZone: #patched
          cidrBlock: 10.0.2.0/24
          vpcIdRef:
            name: #patched
          mapPublicIpOnLaunch: true
          tags:
            kubernetes.io/role/elb: "1"
      providerConfigRef:
        policy:
          resolve: "Always"
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: 'public-%s-1c'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.availabilityZone
      transforms:
      - type: string
        string:
          fmt: '%sc'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.vpcIdRef.name
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.id
      toFieldPath: status.publicSubnet1cID

  - name: private-subnet-1a
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: Subnet
      spec:
        forProvider:
          region: #patched
          availabilityZone: #pached
          cidrBlock: 10.0.100.0/24
          vpcIdRef:
            name: #patched
          tags:
            karpenter.sh/discovery: #patchme
      providerConfigRef:
        policy:
          resolve: "Always"
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: 'private-%s-1a'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.availabilityZone
      transforms:
      - type: string
        string:
          fmt: '%sa'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.vpcIdRef.name
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.tags[karpenter.sh/discovery]
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.id
      toFieldPath: status.privateSubnet1aID

  - name: private-subnet-1b
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: Subnet
      spec:
        forProvider:
          region: #patched
          availabilityZone: #patched
          cidrBlock: 10.0.101.0/24
          vpcIdRef:
            name: #patched
          tags:
            karpenter.sh/discovery: #patchme
      providerConfigRef:
        policy:
          resolve: "Always"
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: 'private-%s-1b'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.availabilityZone
      transforms:
      - type: string
        string:
          fmt: '%sb'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.vpcIdRef.name
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.tags[karpenter.sh/discovery]
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.id
      toFieldPath: status.privateSubnet1bID

  - name: private-subnet-1c
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: Subnet
      spec:
        forProvider:
          region: #patched
          availabilityZone: #patched
          cidrBlock: 10.0.102.0/24
          vpcIdRef:
            name: #patched
          tags:
            karpenter.sh/discovery: #patchme
      providerConfigRef:
        policy:
          resolve: "Always"
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: 'private-%s-1c'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.availabilityZone
      transforms:
      - type: string
        string:
          fmt: '%sc'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.vpcIdRef.name
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.tags[karpenter.sh/discovery]
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.id
      toFieldPath: status.privateSubnet1cID

  - name: nat-gateway-eip
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: EIP
      spec:
        forProvider:
          region: #patchme
          vpc: true
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-nat-gateway'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.id
      toFieldPath: status.natGatewayEIPID

  - name: nat-gateway
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: NATGateway
      spec:
        forProvider:
          allocationIdRef:
            name: #patchme
          region: #patchme
          subnetIdRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: 'private-%s-1c'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.allocationIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-nat-gateway'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.subnetIdRef.name
      transforms:
      - type: string
        string:
          fmt: 'public-%s-1c'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.id
      toFieldPath: status.natGatewayID

  - name: internet-gateway
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: InternetGateway
      spec:
        forProvider:
          region: #patchme
          vpcIdRef:
            name: #patchme
      providerConfigRef:
        policy:
          resolve: "Always"
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.vpcIdRef.name
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.id
      toFieldPath: status.internetGatewayID

  - name: routetable-public
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: RouteTable
      spec:
        forProvider:
          vpcIdRef:
            name: #patchme
          region: #patchme
      providerConfigRef:
        policy:
          resolve: "Always"
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-public'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.vpcIdRef.name
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.id
      toFieldPath: status.publicRouteTableID

  - name: routetable-private
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: RouteTable
      spec:
        forProvider:
          vpcIdRef:
            name: #patchme
          region: #patchme
      providerConfigRef:
        policy:
          resolve: "Always"
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-private'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.vpcIdRef.name
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.id
      toFieldPath: status.privateRouteTableID

  - name: public-route
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: Route
      spec:
        forProvider:
          routeTableIdRef:
            name: #patchme
          gatewayIdRef:
            name: #patchme
          destinationCidrBlock: 0.0.0.0/0
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-public'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.routeTableIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-public'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.gatewayIdRef.name
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: private-route
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: Route
      spec:
        forProvider:
          routeTableIdRef:
            name: #patchme
          natGatewayIdRef:
            name: #patchme
          region: #patchme
          destinationCidrBlock: 0.0.0.0/0
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-private'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.routeTableIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-private'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.natGatewayIdRef.name
      transforms:
      - type: string
        string:
          fmt: 'private-%s-1c'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: private-route-table-assossiation-1a
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: RouteTableAssociation
      spec:
        forProvider:
          region: #patchme
          routeTableIdRef:
            name: #patchme
          subnetIdRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-private-1a'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.routeTableIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-private'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.subnetIdRef.name
      transforms:
      - type: string
        string:
          fmt: 'private-%s-1a'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: private-route-table-assossiation-1b
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: RouteTableAssociation
      spec:
        forProvider:
          region: #patchme
          routeTableIdRef:
            name: #patchme
          subnetIdRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-private-1b'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.routeTableIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-private'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.subnetIdRef.name
      transforms:
      - type: string
        string:
          fmt: 'private-%s-1b'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: private-route-table-assossiation-1c
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: RouteTableAssociation
      spec:
        forProvider:
          region: #patchme
          routeTableId: #patchme
          subnetId: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-private-1c'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.routeTableIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-private'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.subnetIdRef.name
      transforms:
      - type: string
        string:
          fmt: 'private-%s-1c'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: public-route-table-assossiation-1a
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: RouteTableAssociation
      spec:
        forProvider:
          region: #patchme
          routeTableIdRef:
            name: #patchme
          subnetIdRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-public-1a'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.routeTableIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-public'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.subnetIdRef.name
      transforms:
      - type: string
        string:
          fmt: 'public-%s-1a'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: public-route-table-assossiation-1b
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: RouteTableAssociation
      spec:
        forProvider:
          region: #patchme
          routeTableIdRef:
            name: #patchme
          subnetIdRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-public-1b'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.routeTableIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-public'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.subnetIdRef.name
      transforms:
      - type: string
        string:
          fmt: 'public-%s-1b'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: public-route-table-assossiation-1c
    base:
      apiVersion: ec2.aws.upbound.io/v1beta1
      kind: RouteTableAssociation
      spec:
        forProvider:
          region: #patchme
          routeTableIdRef:
            name: #patchme
          subnetIdRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-public-1c'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.routeTableIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-public'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.subnetIdRef.name
      transforms:
      - type: string
        string:
          fmt: 'public-%s-1c'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

# ########
# # EKS Cluster and related resources
# ########
  - name: ekscluster
    base:
      apiVersion: eks.aws.upbound.io/v1beta1
      kind: Cluster
      spec:
        forProvider:
          region: #patchme
          version: #patchme
          vpcConfig:
            - endpointPrivateAccess: true
              endpointPublicAccess: true
              subnetIdRefs:
                - name: #patchme
                - name: #patchme
                - name: #patchme
              securityGroupIdRefs:
                - name: #patchme
          roleArnSelector:
            matchControllerRef: true
      providerConfigRef:
        policy:
          resolve: "Always"
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.eks.version
      toFieldPath: spec.forProvider.version
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.vpcConfig[0].subnetIdRefs[0].name
      transforms:
      - type: string
        string:
          fmt: 'private-%s-1a'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.vpcConfig[0].subnetIdRefs[1].name
      transforms:
      - type: string
        string:
          fmt: 'private-%s-1b'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.vpcConfig[0].subnetIdRefs[2].name
      transforms:
      - type: string
        string:
          fmt: 'private-%s-1c'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.vpcConfig[0].securityGroupIdRefs[0].name
      transforms:
      - type: string
        string:
          fmt: '%s-ekscluster-sg'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.writeConnectionSecretToRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-cluster'
    - type: ToCompositeFieldPath
      fromFieldPath: spec.claimRef.namespace
      toFieldPath: spec.writeConnectionSecretToRef.namespace
    - type: ToCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.roleArnSelector.matchLabels.role
      transforms:
      - type: string
        string:
          fmt: '%s-controlplane'
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.id
      toFieldPath: status.clusterName
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.status
      toFieldPath: status.controlPlaneStatus
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.identity[0].oidc[0].issuer
      toFieldPath: status.clusterOIDC
      transforms:
      - type: string
        string:
          type: TrimPrefix
          trim: 'https://'
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.endpoint
      toFieldPath: status.clusterEndpoint
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.certificateAuthority[0].data
      toFieldPath: status.clusterCertificateAuthorityData
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.vpcConfig[0].clusterSecurityGroupId
      toFieldPath: status.clusterPrimarySecurityGroupId
    readinessChecks:
    - type: MatchString
      fieldPath: status.atProvider.status
      matchString: ACTIVE
    connectionDetails:
    - fromConnectionSecretKey: kubeconfig
    - fromConnectionSecretKey: kubeconfig
      name: value

  - name: identity-provider
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: OpenIDConnectProvider
      spec:
        forProvider:
          url: ""
          clientIdList:
            - sts.amazonaws.com
          thumbprintList:
            - 9e99a48a9960b14926bb7f3b02e22da2b0ab7280 # this is the sts static thumbprint
    patches:
    - type: ToCompositeFieldPath
      fromFieldPath: status.clusterOIDC
      toFieldPath: spec.forProvider.url
      transforms:
      - type: string
        string:
          fmt: "https://%s"
    - type: ToCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
    - type: ToCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: karpenter-fargate-profile
    base:
      apiVersion: eks.aws.upbound.io/v1beta1
      kind: FargateProfile
      metadata:
      spec:
        forProvider:
          clusterNameRef:
            name: #patchme
          podExecutionRoleArnRef:
            name: #patchme
          region: #patchme
          selector:
            - namespace: karpenter
          subnetIdRefs:
          - name: #patchme
          - name: #patchme
          - name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-karpenter'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.clusterNameRef.name
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.podExecutionRoleArnRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-fargate-execution'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.subnetIdRefs[0].name
      transforms:
      - type: string
        string:
          fmt: 'private-%s-1a'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.subnetIdRefs[1].name
      transforms:
      - type: string
        string:
          fmt: 'private-%s-1b'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.subnetIdRefs[2].name
      transforms:
      - type: string
        string:
          fmt: 'private-%s-1c'

  - name: kube-system-fargate-profile
    base:
      apiVersion: eks.aws.upbound.io/v1beta1
      kind: FargateProfile
      metadata:
      spec:
        forProvider:
          clusterNameRef:
            name: #patchme
          podExecutionRoleArnRef:
            name: #patchme
          region: #patchme
          selector:
            - namespace: kube-system
          subnetIdRefs:
          - name: #patchme
          - name: #patchme
          - name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-kube-system'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.clusterNameRef.name
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.podExecutionRoleArnRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-fargate-execution'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.subnetIdRefs[0].name
      transforms:
      - type: string
        string:
          fmt: 'private-%s-1a'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.subnetIdRefs[1].name
      transforms:
      - type: string
        string:
          fmt: 'private-%s-1b'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.subnetIdRefs[2].name
      transforms:
      - type: string
        string:
          fmt: 'private-%s-1c'

  - name: core-dns-addon
    base:
      apiVersion: eks.aws.upbound.io/v1beta1
      kind: Addon
      metadata:
        annotations:
          crossplane.io/external-name: coredns
      spec:
        forProvider:
          addonName: coredns
          clusterNameRef:
            name: #patchme
          region: #patchme
          configurationValues: |
            {
              "computeType": "Fargate"
            }
          resolveConflicts: OVERWRITE
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-core-dns'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.clusterNameRef.name
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: vpc-cni-addon
    base:
      apiVersion: eks.aws.upbound.io/v1beta1
      kind: Addon
      metadata:
        annotations:
          crossplane.io/external-name: vpc-cni
      spec:
        forProvider:
          addonName: vpc-cni
          clusterNameRef:
            name: #patchme
          region: #patchme
          resolveConflicts: OVERWRITE
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-vpc-cni'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.clusterNameRef.name
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: kube-proxy-addon
    base:
      apiVersion: eks.aws.upbound.io/v1beta1
      kind: Addon
      metadata:
        annotations:
          crossplane.io/external-name: kube-proxy
      spec:
        forProvider:
          addonName: kube-proxy
          clusterNameRef:
            name: #patchme
          region: #patchme
          resolveConflicts: OVERWRITE
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-kube-proxy'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.clusterNameRef.name
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: efs
    base:
      apiVersion: efs.aws.upbound.io/v1beta1
      kind: FileSystem
      spec:
        forProvider:
          region: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-efs'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: efs-access-point-1a
    base:
      apiVersion: efs.aws.upbound.io/v1beta1
      kind: MountTarget
      spec:
        forProvider:
          region: #patchme
        fileSystemIdRef:
          name: #patchme
        subnetIdRef:
          name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-efs-ap-1a'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.fileSystemIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-efs'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.subnetIdRef.name
      transforms:
      - type: string
        string:
          fmt: 'private-%s-1a'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: efs-access-point-1b
    base:
      apiVersion: efs.aws.upbound.io/v1beta1
      kind: MountTarget
      spec:
        forProvider:
          region: #patchme
        fileSystemIdRef:
          name: #patchme
        subnetIdRef:
          name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-efs-ap-1b'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.fileSystemIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-efs'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.subnetIdRef.name
      transforms:
      - type: string
        string:
          fmt: 'private-%s-1b'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: efs-access-point-1c
    base:
      apiVersion: efs.aws.upbound.io/v1beta1
      kind: MountTarget
      spec:
        forProvider:
          region: #patchme
        fileSystemIdRef:
          name: #patchme
        subnetIdRef:
          name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-efs-ap-1c'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.fileSystemIdRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-efs'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.subnetIdRef.name
      transforms:
      - type: string
        string:
          fmt: 'private-%s-1c'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name      

# ########
# # IAM Instance Profiles
# ########

  - name: karpenter-instance-profile
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: InstanceProfile
      spec:
        forProvider:
          roleRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-karpenter'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.roleRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-karpenter-cluster'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

# ########
# # IAM Roles
# ########

  - name: mlflow-role
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: Role
      metadata:
        annotations:
          crossplane.io/external-name: mlflow
      spec:
        forProvider:
          assumeRolePolicy: ""
    patches:
      - type: FromCompositeFieldPath
        fromFieldPath: spec.id
        toFieldPath: metadata.name
        transforms:
          - type: string
            string:
              fmt: "%s-mlflow"
      - type: FromCompositeFieldPath
        fromFieldPath: status.id
        toFieldPath: spec.providerConfigRef.name
      - type: CombineFromComposite
        toFieldPath: spec.forProvider.assumeRolePolicy
        combine:
          variables:
            - fromFieldPath: status.id
            - fromFieldPath: status.clusterOIDC
            - fromFieldPath: status.clusterOIDC
            - fromFieldPath: status.clusterOIDC
          strategy: string
          string:
            fmt: |
              {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Sid": "",
                    "Effect": "Allow",
                    "Principal": {
                      "Federated": "arn:aws:iam::%s:oidc-provider/%s"
                    },
                    "Action": "sts:AssumeRoleWithWebIdentity",
                    "Condition": {
                      "StringEquals": {
                          "%s:sub": [
                          "system:serviceaccount:data-tooling:mlflow"],
                          "%s:aud": "sts.amazonaws.com"
                      }
                    }
                  }
                ]
              }
      - type: ToCompositeFieldPath
        fromFieldPath: status.atProvider.id
        toFieldPath: status.mlflowRoleName

  - name: data-service-role
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: Role
      metadata:
        annotations:
          crossplane.io/external-name: data-service
      spec:
        forProvider:
          assumeRolePolicy: ""
    patches:
      - type: FromCompositeFieldPath
        fromFieldPath: spec.id
        toFieldPath: metadata.name
        transforms:
          - type: string
            string:
              fmt: "%s-data-service"
      - type: FromCompositeFieldPath
        fromFieldPath: status.id
        toFieldPath: spec.providerConfigRef.name
      - type: CombineFromComposite
        toFieldPath: spec.forProvider.assumeRolePolicy
        combine:
          variables:
            - fromFieldPath: status.id
            - fromFieldPath: status.clusterOIDC
            - fromFieldPath: status.clusterOIDC
            - fromFieldPath: status.clusterOIDC
          strategy: string
          string:
            fmt: |
              {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Sid": "",
                    "Effect": "Allow",
                    "Principal": {
                      "Federated": "arn:aws:iam::%s:oidc-provider/%s"
                    },
                    "Action": "sts:AssumeRoleWithWebIdentity",
                    "Condition": {
                      "StringEquals": {
                          "%s:sub": [
                          "system:serviceaccount:data-tooling:data-service"],
                          "%s:aud": "sts.amazonaws.com"
                      }
                    }
                  }
                ]
              }
      - type: ToCompositeFieldPath
        fromFieldPath: status.atProvider.id
        toFieldPath: status.dataServiceRoleName

  - name: dataflow-listener-role
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: Role
      metadata:
        annotations:
          crossplane.io/external-name: dataflow-listener
      spec:
        forProvider:
          assumeRolePolicy: ""
    patches:
      - type: FromCompositeFieldPath
        fromFieldPath: spec.id
        toFieldPath: metadata.name
        transforms:
          - type: string
            string:
              fmt: "%s-dataflow-listener"
      - type: FromCompositeFieldPath
        fromFieldPath: status.id
        toFieldPath: spec.providerConfigRef.name
      - type: CombineFromComposite
        toFieldPath: spec.forProvider.assumeRolePolicy
        combine:
          variables:
            - fromFieldPath: status.id
            - fromFieldPath: status.clusterOIDC
            - fromFieldPath: status.clusterOIDC
            - fromFieldPath: status.clusterOIDC
          strategy: string
          string:
            fmt: |
              {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Sid": "",
                    "Effect": "Allow",
                    "Principal": {
                      "Federated": "arn:aws:iam::%s:oidc-provider/%s"
                    },
                    "Action": "sts:AssumeRoleWithWebIdentity",
                    "Condition": {
                      "StringEquals": {
                          "%s:sub": [
                          "system:serviceaccount:data-tooling:dataflow-listener"],
                          "%s:aud": "sts.amazonaws.com"
                      }
                    }
                  }
                ]
              }
      - type: ToCompositeFieldPath
        fromFieldPath: status.atProvider.id
        toFieldPath: status.dataFlowListenerRoleName

  - name: exec-service-python-role
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: Role
      metadata:
        annotations:
          crossplane.io/external-name: exec-service-python
      spec:
        forProvider:
          assumeRolePolicy: ""
    patches:
      - type: FromCompositeFieldPath
        fromFieldPath: spec.id
        toFieldPath: metadata.name
        transforms:
          - type: string
            string:
              fmt: "%s-exec-service-python"
      - type: FromCompositeFieldPath
        fromFieldPath: status.id
        toFieldPath: spec.providerConfigRef.name
      - type: CombineFromComposite
        toFieldPath: spec.forProvider.assumeRolePolicy
        combine:
          variables:
            - fromFieldPath: status.id
            - fromFieldPath: status.clusterOIDC
            - fromFieldPath: status.clusterOIDC
            - fromFieldPath: status.clusterOIDC
          strategy: string
          string:
            fmt: |
              {
                "Version": "2012-10-17",
                "Statement": [
                  {
                    "Sid": "",
                    "Effect": "Allow",
                    "Principal": {
                      "Federated": "arn:aws:iam::%s:oidc-provider/%s"
                    },
                    "Action": "sts:AssumeRoleWithWebIdentity",
                    "Condition": {
                      "StringEquals": {
                          "%s:sub": [
                          "system:serviceaccount:data-tooling:exec-service-python"],
                          "%s:aud": "sts.amazonaws.com"
                      }
                    }
                  }
                ]
              }
      - type: ToCompositeFieldPath
        fromFieldPath: status.atProvider.id
        toFieldPath: status.execServicePythonRoleName

  - name: organization-role
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: Role
      metadata:
        annotations:
          crossplane.io/external-name: OrganizationAccountAccessRole
      spec:
        forProvider:
          assumeRolePolicy: |
            {
                "Version": "2012-10-17",
                "Statement": [
                    {
                        "Effect": "Allow",
                        "Principal": {
                            "AWS": [
                                "{{ .Values.backofficeArgocdRoleArn }}",
                                "arn:aws:iam::543587022756:root"
                            ]
                        },
                        "Action": "sts:AssumeRole"
                    }
                ]
            }
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: "%s-organization-role"
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: fargate-profile-role
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: Role
      spec:
        forProvider:
          assumeRolePolicy: |
            {
                "Version": "2012-10-17",
                "Statement": [
                    {
                        "Sid": "",
                        "Effect": "Allow",
                        "Principal": {
                            "Service": "eks-fargate-pods.amazonaws.com"
                        },
                        "Action": "sts:AssumeRole"
                    }
                ]
            }
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: "%s-fargate-execution"
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.arn
      toFieldPath: status.fargateExecRoleArn
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.id
      toFieldPath: status.fargateExecRoleName

  - name: karpenter-irsa-role
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: Role
      spec:
        forProvider:
          assumeRolePolicy: ""
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: "%s-karpenter"
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
    - type: CombineFromComposite
      toFieldPath: spec.forProvider.assumeRolePolicy
      combine:
        variables:
        - fromFieldPath: status.id
        - fromFieldPath: status.clusterOIDC
        - fromFieldPath: status.clusterOIDC
        - fromFieldPath: status.clusterOIDC
        strategy: string
        string:
          fmt: |
            {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Sid": "",
                  "Effect": "Allow",
                  "Principal": {
                    "Federated": "arn:aws:iam::%s:oidc-provider/%s"
                  },
                  "Action": "sts:AssumeRoleWithWebIdentity",
                  "Condition": {
                    "StringEquals": {
                        "%s:sub": "system:serviceaccount:karpenter:karpenter",
                        "%s:aud": "sts.amazonaws.com"
                    }
                  }
                }
              ]
            }
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.arn
      toFieldPath: status.karpenterIRSARoleArn
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.id
      toFieldPath: status.karpenterIRSARoleName

  - name: karpenter-cluster-role
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: Role
      spec:
        forProvider:
          assumeRolePolicy: |
            {
                "Version": "2012-10-17",
                "Statement": [
                    {
                        "Sid": "EKSNodeAssumeRole",
                        "Effect": "Allow",
                        "Principal": {
                            "Service": "ec2.amazonaws.com"
                        },
                        "Action": "sts:AssumeRole"
                    }
                ]
            }
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: "%s-karpenter-cluster"
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.arn
      toFieldPath: status.karpenterClusterRoleArn
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.id
      toFieldPath: status.karpenterClusterRoleName

  - name: vpc-cni-addon-role
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: Role
      spec:
        forProvider:
          assumeRolePolicy: ""
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: "%s-vpc-cni"
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
    - type: CombineFromComposite
      toFieldPath: spec.forProvider.assumeRolePolicy
      combine:
        variables:
        - fromFieldPath: status.id
        - fromFieldPath: status.clusterOIDC
        - fromFieldPath: status.clusterOIDC
        - fromFieldPath: status.clusterOIDC
        strategy: string
        string:
          fmt: |
            {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Sid": "",
                  "Effect": "Allow",
                  "Principal": {
                    "Federated": "arn:aws:iam::%s:oidc-provider/%s"
                  },
                  "Action": "sts:AssumeRoleWithWebIdentity",
                  "Condition": {
                    "StringEquals": {
                        "%s:sub": "system:serviceaccount:kube-system:aws-node",
                        "%s:aud": "sts.amazonaws.com"
                    }
                  }
                }
              ]
            }
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.arn
      toFieldPath: status.vpcCniRoleArn
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.id
      toFieldPath: status.vpcCniRoleName

  - name: iamrole-controlplane
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: Role
      spec:
        forProvider:
          assumeRolePolicy: |
            {
              "Version": "2012-10-17",
              "Statement": [
                  {
                      "Effect": "Allow",
                      "Principal": {
                          "Service": [
                              "eks.amazonaws.com"
                          ]
                      },
                      "Action": [
                          "sts:AssumeRole"
                      ]
                  }
              ]
            }
      providerConfigRef:
        policy:
          resolve: "Always"
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-controlplane'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.labels.role
      transforms:
      - type: string
        string:
          fmt: '%s-controlplane'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: iamrole-nodegroup
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: Role
      spec:
        forProvider:
          assumeRolePolicy: |
            {
              "Version": "2012-10-17",
              "Statement": [
                  {
                      "Effect": "Allow",
                      "Principal": {
                          "Service": [
                              "ec2.amazonaws.com"
                          ]
                      },
                      "Action": [
                          "sts:AssumeRole"
                      ]
                  }
              ]
            }
      providerConfigRef:
        policy:
          resolve: "Always"
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-nodegroup'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.labels.role
      transforms:
      - type: string
        string:
          fmt: '%s-nodegroup'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: iamrole-ebs-csi-driver
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: Role
      spec:
        forProvider:
          assumeRolePolicy: ""
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: "%s-ebs-csi-driver"
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
    - type: CombineFromComposite
      toFieldPath: spec.forProvider.assumeRolePolicy
      combine:
        variables:
        - fromFieldPath: status.id
        - fromFieldPath: status.clusterOIDC
        - fromFieldPath: status.clusterOIDC
        - fromFieldPath: status.clusterOIDC
        strategy: string
        string:
          fmt: |
            {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Sid": "",
                  "Effect": "Allow",
                  "Principal": {
                    "Federated": "arn:aws:iam::%s:oidc-provider/%s"
                  },
                  "Action": "sts:AssumeRoleWithWebIdentity",
                  "Condition": {
                    "StringEquals": {
                        "%s:sub": "system:serviceaccount:addons:ebs-csi-controller-sa",
                        "%s:aud": "sts.amazonaws.com"
                    }
                  }
                }
              ]
            }
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.labels.role
      transforms:
      - type: string
        string:
          fmt: '%s-ebs-csi-driver'

  - name: iamrole-efs-csi-driver
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: Role
      spec:
        forProvider:
          assumeRolePolicy: ""
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: "%s-efs-csi-driver"
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
    - type: CombineFromComposite
      toFieldPath: spec.forProvider.assumeRolePolicy
      combine:
        variables:
        - fromFieldPath: status.id
        - fromFieldPath: status.clusterOIDC
        - fromFieldPath: status.clusterOIDC
        - fromFieldPath: status.clusterOIDC
        strategy: string
        string:
          fmt: |
            {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Sid": "",
                  "Effect": "Allow",
                  "Principal": {
                    "Federated": "arn:aws:iam::%s:oidc-provider/%s"
                  },
                  "Action": "sts:AssumeRoleWithWebIdentity",
                  "Condition": {
                    "StringEquals": {
                        "%s:aud": "sts.amazonaws.com",
                        "%s:sub": [
                          "system:serviceaccount:addons:efs-csi-controller-sa",
                          "system:serviceaccount:addons:efs-csi-node-sa"
                        ]
                    }
                  }
                }
              ]
            }
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.labels.role
      transforms:
      - type: string
        string:
          fmt: '%s-efs-csi-driver'

  - name: iamrole-external-dns
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: Role
      spec:
        forProvider:
          assumeRolePolicy: ""
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: "%s-external-dns"
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
    - type: CombineFromComposite
      toFieldPath: spec.forProvider.assumeRolePolicy
      combine:
        variables:
        - fromFieldPath: status.id
        - fromFieldPath: status.clusterOIDC
        - fromFieldPath: status.clusterOIDC
        - fromFieldPath: status.clusterOIDC
        strategy: string
        string:
          fmt: |
            {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Sid": "",
                  "Effect": "Allow",
                  "Principal": {
                    "Federated": "arn:aws:iam::%s:oidc-provider/%s"
                  },
                  "Action": "sts:AssumeRoleWithWebIdentity",
                  "Condition": {
                    "StringEquals": {
                        "%s:sub": "system:serviceaccount:addons:external-dns",
                        "%s:aud": "sts.amazonaws.com"
                    }
                  }
                }
              ]
            }
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.labels.role
      transforms:
      - type: string
        string:
          fmt: '%s-external-dns'
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.arn
      toFieldPath: status.externalDnsRoleArn

# ########
# # IAM Policies
# ########

  - name: client-dev-s3-policy
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: Policy
      metadata:
        annotations:
          crossplane.io/external-name: client-dev-s3-full-access
      spec:
        forProvider:
          policy: #patchme
    patches:
    - type: CombineFromComposite
      toFieldPath: spec.forProvider.policy
      combine:
        variables:
        - fromFieldPath: status.id
        - fromFieldPath: spec.id
        - fromFieldPath: status.id
        - fromFieldPath: spec.id
        strategy: string
        string:
          fmt: |
              {
                  "Statement": [
                      {
                          "Action": [
                              "s3:*"
                          ],
                          "Effect": "Allow",
                          "Resource": [
                              "arn:aws:s3:::client-dev-%s-%s",
                              "arn:aws:s3:::client-dev-%s-%s/*"
                          ]
                      }
                  ],
                  "Version": "2012-10-17"
              }
      - fromFieldPath: spec.id
        toFieldPath: metadata.name
        transforms:
          - type: string
            string:
              fmt: "%s-client-dev-s3-full-access"
      - type: FromCompositeFieldPath
        fromFieldPath: status.id
        toFieldPath: spec.providerConfigRef.name
      - type: ToCompositeFieldPath
        fromFieldPath: status.atProvider.id
        toFieldPath: status.clientDevS3PolicyArn

  - name: artifact-store-s3-policy
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: Policy
      metadata:
        annotations:
          crossplane.io/external-name: artifact-store-s3-full-access
      spec:
        forProvider:
          policy: #patchme
    patches:
    - type: CombineFromComposite
      toFieldPath: spec.forProvider.policy
      combine:
        variables:
        - fromFieldPath: status.id
        - fromFieldPath: spec.id
        - fromFieldPath: status.id
        - fromFieldPath: spec.id
        strategy: string
        string:
          fmt: |
              {
                  "Statement": [
                      {
                          "Action": [
                              "s3:*"
                          ],
                          "Effect": "Allow",
                          "Resource": [
                              "arn:aws:s3:::artifact-store-%s-%s",
                              "arn:aws:s3:::artifact-store-%s-%s/*"
                          ]
                      }
                  ],
                  "Version": "2012-10-17"
              }
      - fromFieldPath: spec.id
        toFieldPath: metadata.name
        transforms:
          - type: string
            string:
              fmt: "%s-artifact-store-s3-full-access"
      - type: FromCompositeFieldPath
        fromFieldPath: status.id
        toFieldPath: spec.providerConfigRef.name
      - type: ToCompositeFieldPath
        fromFieldPath: status.atProvider.id
        toFieldPath: status.artifactStoreS3PolicyArn

  - name: karpenter-irsa-policy
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: Policy
      spec:
        forProvider:
          policy: "{}"
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-karpenter-irsa'
    - type: CombineFromComposite
      toFieldPath: spec.forProvider.policy
      policy:
        fromFieldPath: Required
      combine:
        variables:
          - fromFieldPath: status.clusterName
          - fromFieldPath: status.clusterName
          - fromFieldPath: status.id
          - fromFieldPath: status.id
          - fromFieldPath: status.id
          - fromFieldPath: status.id
          - fromFieldPath: status.id
          - fromFieldPath: status.id
          - fromFieldPath: status.id
          - fromFieldPath: status.karpenterClusterRoleArn
          - fromFieldPath: spec.parameters.region
          - fromFieldPath: status.id
          - fromFieldPath: spec.id
        strategy: string
        string:
          fmt: |
            {
                "Statement": [
                    {
                        "Action": [
                            "pricing:GetProducts",
                            "ec2:DescribeSubnets",
                            "ec2:DescribeSpotPriceHistory",
                            "ec2:DescribeSecurityGroups",
                            "ec2:DescribeLaunchTemplates",
                            "ec2:DescribeInstances",
                            "ec2:DescribeInstanceTypes",
                            "ec2:DescribeInstanceTypeOfferings",
                            "ec2:DescribeImages",
                            "ec2:DescribeAvailabilityZones",
                            "ec2:CreateTags",
                            "ec2:CreateLaunchTemplate",
                            "ec2:CreateFleet"
                        ],
                        "Effect": "Allow",
                        "Resource": "*",
                        "Sid": ""
                    },
                    {
                        "Action": [
                            "ec2:TerminateInstances",
                            "ec2:DeleteLaunchTemplate"
                        ],
                        "Condition": {
                            "StringEquals": {
                                "ec2:ResourceTag/karpenter.sh/discovery": "%s"
                            }
                        },
                        "Effect": "Allow",
                        "Resource": "*",
                        "Sid": ""
                    },
                    {
                        "Action": "ec2:RunInstances",
                        "Condition": {
                            "StringEquals": {
                                "ec2:ResourceTag/karpenter.sh/discovery": "%s"
                            }
                        },
                        "Effect": "Allow",
                        "Resource": "arn:aws:ec2:*:%s:launch-template/*",
                        "Sid": ""
                    },
                    {
                        "Action": "ec2:RunInstances",
                        "Effect": "Allow",
                        "Resource": [
                            "arn:aws:ec2:*::image/*",
                            "arn:aws:ec2:*:%s:volume/*",
                            "arn:aws:ec2:*:%s:subnet/*",
                            "arn:aws:ec2:*:%s:spot-instances-request/*",
                            "arn:aws:ec2:*:%s:security-group/*",
                            "arn:aws:ec2:*:%s:network-interface/*",
                            "arn:aws:ec2:*:%s:instance/*"
                        ],
                        "Sid": ""
                    },
                    {
                        "Action": "ssm:GetParameter",
                        "Effect": "Allow",
                        "Resource": "arn:aws:ssm:*:*:parameter/aws/service/*",
                        "Sid": ""
                    },
                    {
                        "Action": "iam:PassRole",
                        "Effect": "Allow",
                        "Resource": "%s",
                        "Sid": ""
                    },
                    {
                        "Action": [
                            "sqs:ReceiveMessage",
                            "sqs:GetQueueUrl",
                            "sqs:GetQueueAttributes",
                            "sqs:DeleteMessage"
                        ],
                        "Effect": "Allow",
                        "Resource": "arn:aws:sqs:%s:%s:%s-karpenter-cluster",
                        "Sid": ""
                    }
                ],
                "Version": "2012-10-17"
            }
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.id
      toFieldPath: status.karpenterIRSAPolicyArn

  - name: efs-csi-driver-policy
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: Policy
      spec:
        forProvider:
          policy: |
            {
              "Version": "2012-10-17",
              "Statement": [
                {
                  "Effect": "Allow",
                  "Action": [
                    "elasticfilesystem:DescribeAccessPoints",
                    "elasticfilesystem:DescribeFileSystems",
                    "elasticfilesystem:DescribeMountTargets",
                    "ec2:DescribeAvailabilityZones"
                  ],
                  "Resource": "*"
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "elasticfilesystem:CreateAccessPoint"
                  ],
                  "Resource": "*",
                  "Condition": {
                    "StringLike": {
                      "aws:RequestTag/efs.csi.aws.com/cluster": "true"
                    }
                  }
                },
                {
                  "Effect": "Allow",
                  "Action": [
                    "elasticfilesystem:TagResource"
                  ],
                  "Resource": "*",
                  "Condition": {
                    "StringLike": {
                      "aws:ResourceTag/efs.csi.aws.com/cluster": "true"
                    }
                  }
                },
                {
                  "Effect": "Allow",
                  "Action": "elasticfilesystem:DeleteAccessPoint",
                  "Resource": "*",
                  "Condition": {
                    "StringEquals": {
                      "aws:ResourceTag/efs.csi.aws.com/cluster": "true"
                    }
                  }
                }
              ]
            }
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-efs-csi'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
    
  - name: external-dns-policy
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: Policy
      spec:
        forProvider:
          policy: "{}"
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-external-dns'
    - type: CombineFromComposite
      toFieldPath: spec.forProvider.policy
      policy:
        fromFieldPath: Required
      combine:
        variables:
          - fromFieldPath: status.zoneId
        strategy: string
        string:
          fmt: |
            {
                "Version": "2012-10-17",
                "Statement": [
                    {
                        "Sid": "ChangeResourceRecordSets",
                        "Effect": "Allow",
                        "Action": "route53:ChangeResourceRecordSets",
                        "Resource": "arn:aws:route53:::hostedzone/%s"
                    },
                    {
                        "Sid": "ListResourceRecordSetsAndHostedZones",
                        "Effect": "Allow",
                        "Action": [
                            "route53:ListResourceRecordSets",
                            "route53:ListHostedZones"
                        ],
                        "Resource": "*"
                    }
                ]
            }
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

# ########
# # IAM Policy Attachments
# ########

  - name: mlflow-client-dev-policy-attachment
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: RolePolicyAttachment
      spec:
        forProvider:
          policyArn: #patchme
          role: #patchme
    patches:
      - fromFieldPath: spec.id
        toFieldPath: metadata.name
        transforms:
          - type: string
            string:
              fmt: "%s-mlflow-client-dev"
      - type: FromCompositeFieldPath
        fromFieldPath: status.clientDevS3PolicyArn
        toFieldPath: spec.forProvider.policyArn
      - type: FromCompositeFieldPath
        fromFieldPath: status.mlflowRoleName
        toFieldPath: spec.forProvider.role
      - type: FromCompositeFieldPath
        fromFieldPath: status.id
        toFieldPath: spec.providerConfigRef.name

  - name: data-service-client-dev-policy-attachment
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: RolePolicyAttachment
      spec:
        forProvider:
          policyArn: #patchme
          role: #patchme
    patches:
      - fromFieldPath: spec.id
        toFieldPath: metadata.name
        transforms:
          - type: string
            string:
              fmt: "%s-data-service-client-dev"
      - type: FromCompositeFieldPath
        fromFieldPath: status.clientDevS3PolicyArn
        toFieldPath: spec.forProvider.policyArn
      - type: FromCompositeFieldPath
        fromFieldPath: status.dataServiceRoleName
        toFieldPath: spec.forProvider.role
      - type: FromCompositeFieldPath
        fromFieldPath: status.id
        toFieldPath: spec.providerConfigRef.name

  - name: data-service-artifact-store-policy-attachment
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: RolePolicyAttachment
      spec:
        forProvider:
          policyArn: #patchme
          role: #patchme
    patches:
      - fromFieldPath: spec.id
        toFieldPath: metadata.name
        transforms:
          - type: string
            string:
              fmt: "%s-data-service-artifact-store"
      - type: FromCompositeFieldPath
        fromFieldPath: status.artifactStoreS3PolicyArn
        toFieldPath: spec.forProvider.policyArn
      - type: FromCompositeFieldPath
        fromFieldPath: status.dataServiceRoleName
        toFieldPath: spec.forProvider.role
      - type: FromCompositeFieldPath
        fromFieldPath: status.id
        toFieldPath: spec.providerConfigRef.name


  - name: data-flow-listener-client-dev-policy-attachment
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: RolePolicyAttachment
      spec:
        forProvider:
          policyArn: #patchme
          role: #patchme
    patches:
      - fromFieldPath: spec.id
        toFieldPath: metadata.name
        transforms:
          - type: string
            string:
              fmt: "%s-data-flow-listener-client-dev"
      - type: FromCompositeFieldPath
        fromFieldPath: status.clientDevS3PolicyArn
        toFieldPath: spec.forProvider.policyArn
      - type: FromCompositeFieldPath
        fromFieldPath: status.dataFlowListenerRoleName
        toFieldPath: spec.forProvider.role
      - type: FromCompositeFieldPath
        fromFieldPath: status.id
        toFieldPath: spec.providerConfigRef.name

  - name: data-flow-listener-artifact-store-policy-attachment
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: RolePolicyAttachment
      spec:
        forProvider:
          policyArn: #patchme
          role: #patchme
    patches:
      - fromFieldPath: spec.id
        toFieldPath: metadata.name
        transforms:
          - type: string
            string:
              fmt: "%s-data-flow-listener-artifact-store"
      - type: FromCompositeFieldPath
        fromFieldPath: status.artifactStoreS3PolicyArn
        toFieldPath: spec.forProvider.policyArn
      - type: FromCompositeFieldPath
        fromFieldPath: status.dataFlowListenerRoleName
        toFieldPath: spec.forProvider.role
      - type: FromCompositeFieldPath
        fromFieldPath: status.id
        toFieldPath: spec.providerConfigRef.name

  - name: exec-service-python-artifact-store-policy-attachment
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: RolePolicyAttachment
      spec:
        forProvider:
          policyArn: #patchme
          role: #patchme
    patches:
      - fromFieldPath: spec.id
        toFieldPath: metadata.name
        transforms:
          - type: string
            string:
              fmt: "%s-exec-service-python-artifact-store"
      - type: FromCompositeFieldPath
        fromFieldPath: status.artifactStoreS3PolicyArn
        toFieldPath: spec.forProvider.policyArn
      - type: FromCompositeFieldPath
        fromFieldPath: status.execServicePythonRoleName
        toFieldPath: spec.forProvider.role
      - type: FromCompositeFieldPath
        fromFieldPath: status.id
        toFieldPath: spec.providerConfigRef.name

  - name: fargate-policy-attachment
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: RolePolicyAttachment
      spec:
        forProvider:
          policyArn: arn:aws:iam::aws:policy/AmazonEKSFargatePodExecutionRolePolicy
          roleRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-fargate-execution'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.roleRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-fargate-execution'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: fargate-cni-policy-attachment
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: RolePolicyAttachment
      spec:
        forProvider:
          policyArn: arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy
          roleRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-fargate-cni'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.roleRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-fargate-execution'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: karpenter-eks-worker-policy
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: RolePolicyAttachment
      spec:
        forProvider:
          policyArn: arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy
          roleRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-karpenter-eks-worker-node'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.roleRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-karpenter-cluster'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: karpenter-ec2-container-registry-policy
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: RolePolicyAttachment
      spec:
        forProvider:
          policyArn: arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
          roleRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-karpenter-ec2-container-registry'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.roleRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-karpenter-cluster'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: karpenter-ssm-managed-instance-policy
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: RolePolicyAttachment
      spec:
        forProvider:
          policyArn: arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
          roleRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-karpenter-ssm-managed-instance'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.roleRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-karpenter-cluster'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: karpenter-cni-policy
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: RolePolicyAttachment
      spec:
        forProvider:
          policyArn: arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy
          roleRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-karpenter-cluster-cni'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.roleRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-karpenter-cluster'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: karpenter-irsa-policy-attachment
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: RolePolicyAttachment
      spec:
        forProvider:
          policyArnRef:
            name: #patchme # arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy
          roleRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-karpenter-irsa-attachment'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.policyArnRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-karpenter-irsa'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.roleRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-karpenter'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: iamattachment-controlplane
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: RolePolicyAttachment
      spec:
        forProvider:
          policyArn: arn:aws:iam::aws:policy/AmazonEKSClusterPolicy
          roleRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-controlplane'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.roleRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-controlplane'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: iamattachment-service
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: RolePolicyAttachment
      spec:
        forProvider:
          policyArn: arn:aws:iam::aws:policy/AmazonEKSServicePolicy
          roleRef:
            name: #patchme
      providerConfigRef:
        policy:
          resolve: "Always"
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-service'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.roleRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-controlplane'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: iamattachment-worker
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: RolePolicyAttachment
      spec:
        forProvider:
          policyArn: arn:aws:iam::aws:policy/AmazonEKSWorkerNodePolicy
          roleRef:
            name: #patchme
      providerConfigRef:
        policy:
          resolve: "Always"
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-worker'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.roleRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-nodegroup'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: iamattachment-cni
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: RolePolicyAttachment
      spec:
        forProvider:
          policyArn: arn:aws:iam::aws:policy/AmazonEKS_CNI_Policy
          roleRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-cni'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.roleRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-vpc-cni'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: iamattachment-registry
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: RolePolicyAttachment
      spec:
        forProvider:
          policyArn: arn:aws:iam::aws:policy/AmazonEC2ContainerRegistryReadOnly
          roleRef:
            name: #patch
      providerConfigRef:
        policy:
          resolve: "Always"
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-registry'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.roleRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-nodegroup'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: iamattachment-ebs-csi-driver
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: RolePolicyAttachment
      spec:
        forProvider:
          policyArn: arn:aws:iam::aws:policy/service-role/AmazonEBSCSIDriverPolicy
          roleRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-ebs-csi-driver'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.roleRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-ebs-csi-driver'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: iamattachment-efs-csi-driver
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: RolePolicyAttachment
      spec:
        forProvider:
          policyArnRef: #patchme
          roleRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-efs-csi-driver'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.roleRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-efs-csi-driver'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.policyArnRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-efs-csi'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
    
  - name: iamattachment-external-dns
    base:
      apiVersion: iam.aws.upbound.io/v1beta1
      kind: RolePolicyAttachment
      spec:
        forProvider:
          policyArnRef: #patchme
          roleRef:
            name: #patchme
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-external-dns'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.roleRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-external-dns'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.policyArnRef.name
      transforms:
      - type: string
        string:
          fmt: '%s-external-dns'
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

#####
# ArgoCD
#####
  - name: argocd-secret-remote-cluster-credentials
    base:
      apiVersion: kubernetes.crossplane.io/v1alpha1
      kind: Object
      spec:
        forProvider:
          manifest:
            apiVersion: v1
            kind: Secret
            metadata:
              name: # patched
              namespace: argocd
              labels:
                argocd.argoproj.io/secret-type: cluster
            # stringData:
              # name: # patched
              # server: # patched
              # config:
              #   awsAuthConfig:
              #       clusterName: # patched
              #       roleARN: # patched
            type: Opaque
        providerConfigRef:
          name: kubernetes-provider
    patches:
      - type: FromCompositeFieldPath
        fromFieldPath: spec.id
        toFieldPath: metadata.name
      - type: FromCompositeFieldPath
        fromFieldPath: spec.id
        toFieldPath: spec.forProvider.manifest.metadata.name
        transforms:
          - type: string
            string:
              fmt: "%s-argocd-cluster-secret"
      - type: FromCompositeFieldPath
        fromFieldPath: spec.id
        toFieldPath: spec.forProvider.manifest.stringData.name
      - type: FromCompositeFieldPath
        fromFieldPath: status.clusterEndpoint
        toFieldPath: spec.forProvider.manifest.stringData.server
      - type: CombineFromComposite
        combine:
          variables:
            - fromFieldPath: status.clusterCertificateAuthorityData
            - fromFieldPath: spec.id
            - fromFieldPath: status.id
          strategy: string
          string:
            fmt: |
              {
                "tlsClientConfig":{
                  "insecure":false,
                  "caData":"%s"
                },
                "awsAuthConfig":{
                  "clusterName":"%s",
                  "roleARN":"arn:aws:iam::%s:role/OrganizationAccountAccessRole"
                }
              }
        toFieldPath: spec.forProvider.manifest.stringData.config
        policy:
          fromFieldPath: Required
#####
# Route53
#####
  - name: route53-zone
    base:
      apiVersion: route53.aws.upbound.io/v1beta1
      kind: Zone
      spec:
        forProvider:
          name: #patchme
          config:
            comment: #patchme
            privateZone: false
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.name
      transforms:
        - type: string
          string:
            fmt: "%s.ubix.io"
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: spec.forProvider.config.comment
      transforms:
        - type: string
          string:
            fmt: "%s.ubix.io-ZONE"
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.nameServers
      toFieldPath: status.zoneNameServers
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.zoneId
      toFieldPath: status.zoneId

  - name: route53-record
    base:
      apiVersion: route53.aws.upbound.io/v1beta1
      kind: Record
      spec:
        forProvider:
          name: #patchme
          type: NS
          ttl: 300
          zoneId: {{ .Values.zoneId }}
        providerConfigRef:
          name: root
    patches:
      - type: FromCompositeFieldPath
        fromFieldPath: spec.id
        toFieldPath: metadata.name
      - type: FromCompositeFieldPath
        fromFieldPath: spec.id
        toFieldPath: spec.forProvider.name
      - type: FromCompositeFieldPath
        fromFieldPath: spec.parameters.region
        toFieldPath: spec.forProvider.region
      - type: FromCompositeFieldPath
        fromFieldPath: status.zoneNameServers
        toFieldPath: spec.forProvider.records

#####
# S3
#####
 
  - name: artifact-store-bucket
    base:
      apiVersion: s3.aws.upbound.io/v1beta1
      kind: Bucket
      metadata:
        annotations:
          crossplane.io/external-name: #patchme
      spec:
        forProvider:
          region: #patchme
    patches:
    - type: CombineFromComposite
      combine:
        variables:
          - fromFieldPath: status.id
        strategy: string
        string:
          fmt: "%s-artifact-store"
      toFieldPath: metadata.name
    - type: CombineFromComposite
      combine:
        variables:
          - fromFieldPath: status.id
          - fromFieldPath: spec.id
        strategy: string
        string:
          fmt: "artifact-store-%s-%s"
      toFieldPath: metadata.annotations[crossplane.io/external-name]
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.id
      toFieldPath: status.artifactStoreBucketNameBucketName

  - name: artifact-store-bucket-policies
    base:
      apiVersion: s3.aws.upbound.io/v1beta1
      kind: BucketPublicAccessBlock
      spec:
        forProvider:
          blockPublicAcls: true
          blockPublicPolicy: true
          ignorePublicAcls: true
          restrictPublicBuckets: true
          bucket: #patched
          region: #patched
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-artifact-store'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.status.artifactStoreBucketNameBucketName
      toFieldPath: spec.forProvider.bucket
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: artifact-store-bucket-acl
    base:
      apiVersion: s3.aws.upbound.io/v1beta1
      kind: BucketACL
      spec:
        forProvider:
          acl: private
          bucket: #patched
          region: #patched
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-artifact-store'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.status.artifactStoreBucketNameBucketName
      toFieldPath: spec.forProvider.bucket
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
 
  - name: client-dev-bucket
    base:
      apiVersion: s3.aws.upbound.io/v1beta1
      kind: Bucket
      metadata:
        annotations:
          crossplane.io/external-name: #patchme
      spec:
        forProvider:
          region: #patchme
    patches:
    - type: CombineFromComposite
      combine:
        variables:
          - fromFieldPath: status.id
        strategy: string
        string:
          fmt: "%s-client-dev"
      toFieldPath: metadata.name
    - type: CombineFromComposite
      combine:
        variables:
          - fromFieldPath: status.id
          - fromFieldPath: spec.id
        strategy: string
        string:
          fmt: "client-dev-%s-%s"
      toFieldPath: metadata.annotations[crossplane.io/external-name]
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
    - type: ToCompositeFieldPath
      fromFieldPath: status.atProvider.id
      toFieldPath: status.artifactStoreBucketNameBucketName

  - name: client-dev-bucket-policies
    base:
      apiVersion: s3.aws.upbound.io/v1beta1
      kind: BucketPublicAccessBlock
      spec:
        forProvider:
          blockPublicAcls: true
          blockPublicPolicy: true
          ignorePublicAcls: true
          restrictPublicBuckets: true
          bucket: #patched
          region: #patched
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-client-dev'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.status.artifactStoreBucketNameBucketName
      toFieldPath: spec.forProvider.bucket
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name

  - name: client-dev-bucket-acl
    base:
      apiVersion: s3.aws.upbound.io/v1beta1
      kind: BucketACL
      spec:
        forProvider:
          acl: private
          bucket: #patched
          region: #patched
    patches:
    - type: FromCompositeFieldPath
      fromFieldPath: spec.id
      toFieldPath: metadata.name
      transforms:
      - type: string
        string:
          fmt: '%s-client-dev'
    - type: FromCompositeFieldPath
      fromFieldPath: spec.parameters.region
      toFieldPath: spec.forProvider.region
    - type: FromCompositeFieldPath
      fromFieldPath: spec.status.artifactStoreBucketNameBucketName
      toFieldPath: spec.forProvider.bucket
    - type: FromCompositeFieldPath
      fromFieldPath: status.id
      toFieldPath: spec.providerConfigRef.name
